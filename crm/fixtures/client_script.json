[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Lead",
  "enabled": 0,
  "modified": "2024-11-26 19:39:12.998915",
  "module": "FCRM",
  "name": "Visiting",
  "script": "frappe.ui.form.on('CRM Lead', {\n    status: function (frm) {\n        // Only proceed for specific statuses\n        if (!['Showing', 'Visiting'].includes(frm.doc.status)) return;\n\n        // Prevent double triggering\n        if (frm.doc.__status_checked) return;\n        frm.doc.__status_checked = true;\n\n        frappe.call({\n            method: \"crm.forkanban.check_existing_events\",\n            args: {\n                lead_name: frm.doc.name,\n                lead_status: frm.doc.status\n            },\n            callback: function (response) {\n                if (response.message.exists) {\n                    // Show existing events in a styled table\n                    const events = response.message.events;\n                    const tableHtml = `\n                        <div class=\"event-table-container\">\n                            <table class=\"event-table\">\n                                <thead>\n                                    <tr>\n                                        <th>Subject</th>\n                                        <th>Status</th>\n                                        <th>Starts On</th>\n                                        <th>Sync with Google Calendar</th>\n                                        <th>Google Calendar</th>\n                                    </tr>\n                                </thead>\n                                <tbody>\n                                    ${events.map(event => `\n                                        <tr>\n                                            <td>${event.subject}</td>\n                                            <td>${event.status}</td>\n                                            <td>${event.starts_on}</td>\n                                            <td>${event.sync_with_google_calendar ? 'Yes' : 'No'}</td>\n                                            <td>${event.google_calendar || 'N/A'}</td>\n                                        </tr>\n                                    `).join('')}\n                                </tbody>\n                            </table>\n                        </div>\n                    `;\n                    frappe.msgprint(__(`${frm.doc.status} event(s) already exist for this Lead:<br>${tableHtml}`));\n                } else {\n                    // Show a dialog for creating a new event\n                    const dialog = new frappe.ui.Dialog({\n                        title: `Add ${frm.doc.status} Event`,\n                        fields: [\n                            { label: 'Subject', fieldtype: 'Data', fieldname: 'subject', reqd: 1 },\n                            { label: `${frm.doc.status} Description`, fieldtype: 'Small Text', fieldname: 'description' },\n                            { label: 'Starts On', fieldtype: 'Datetime', fieldname: 'starts_on' },\n                            { label: 'Sync with Google Calendar', fieldtype: 'Check', fieldname: 'sync_with_google_calendar' },\n                            { label: 'Google Calendar', fieldtype: 'Link', fieldname: 'google_calendar', options: 'Google Calendar' }\n                        ],\n                        primary_action_label: `Add ${frm.doc.status} Event`,\n                        primary_action(data) {\n                            frappe.call({\n                                method: \"frappe.client.insert\",\n                                args: {\n                                    doc: {\n                                        doctype: 'Event',\n                                        subject: data.subject,\n                                        description: data.description,\n                                        starts_on: data.starts_on,\n                                        sync_with_google_calendar: data.sync_with_google_calendar,\n                                        google_calendar: data.google_calendar,\n                                        reference_doctype: frm.doctype,\n                                        reference_docname: frm.doc.name,\n                                        showing: frm.doc.status === 'Showing' ? 1 : 0,\n                                        visiting: frm.doc.status === 'Visiting' ? 1 : 0\n                                    }\n                                },\n                                callback: function (res) {\n                                    dialog.hide();\n                                    frappe.msgprint(__('Event Added Successfully!'));\n                                }\n                            });\n                        }\n                    });\n                    dialog.show();\n                }\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Lead",
  "enabled": 1,
  "modified": "2024-12-04 10:29:50.333946",
  "module": "FCRM",
  "name": "Duplicated Lead",
  "script": "frappe.ui.form.on('CRM Lead', {\n    validate: function(frm) {\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'CRM Lead',\n                filters: [\n                    ['phone', '=', frm.doc.phone],\n                    ['name', '!=', frm.doc.name] // Exclude the current document\n                ],\n                fields: ['name', 'duplicated', 'owner'] // Include the owner field for notification\n            },\n            callback: function(response) {\n                if (response.message.length > 0) {\n                    // Update duplicated_label for the existing lead\n                    let existing_lead = response.message[0];\n\n                    frappe.call({\n                        method: 'frappe.client.set_value',\n                        args: {\n                            doctype: 'CRM Lead',\n                            name: existing_lead.name,\n                            fieldname: 'duplicated',\n                            value: 1\n                        },\n                        callback: function() {\n                            frappe.msgprint({\n                                message: __('Phone number already exists for Lead {0}', [existing_lead.name]),\n                                indicator: 'orange',\n                                alert: true\n                            });\n                            frappe.validated = false; // Prevent saving the current lead\n                        }\n                    });\n                }\n            }\n        });\n    }\n});\n",
  "view": "Form"
 }
]